<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>Dougiefresh:Split_Forum</id>
<version>1.37/version>

<!---------------------------------------------------------------------------->
<!-- Source File Edits														-->
<!---------------------------------------------------------------------------->
<file name="$boarddir/index.php">
	<operation>
		<search position="after"><![CDATA[// Check if the user should be disallowed access.]]></search>
		<add><![CDATA[// Make sure that the user has access to this subforum:
	SplitForum_DenyAccess();
	
	]]></add>
	</operation>
</file>
<file name="$boarddir/SSI.php">
	<operation>
		<search position="before"><![CDATA[function ssi_queryPosts($query_where = '', $query_where_params = array(), $query_limit = 10, $query_order = 'm.id_msg DESC', $output_method = 'echo', $limit_body = false, $override_permissions = false)
{
	global $context, $settings, $scripturl, $txt, $db_prefix, $user_info]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board)]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[WHERE 1=1 ' . ($override_permissions ? '' : ']]></search>
		<add><![CDATA[WHERE c.forumid = {int:forumid} ' . ($override_permissions ? '' : ']]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['current_member' => $user_info['id'],
			'is_approved' => 1,]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[function ssi_recentTopics($num_recent = 8, $exclude_boards = null, $include_boards = null, $output_method = 'echo')
{
	global $context, $settings, $scripturl, $txt, $db_prefix, $user_info]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}messages AS m ON (m.id_msg = t.id_last_msg)
			INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[WHERE t.id_last_msg >= {int:min_message_id}]]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['current_member' => $user_info['id'],
			'include_boards' => empty($include_boards) ? '' : $include_boards,]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[function ssi_topBoards($num_top = 10, $output_method = 'echo')
{
	global $context, $settings, $db_prefix, $txt, $scripturl, $user_info, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[LEFT JOIN {db_prefix}log_boards AS lb ON (lb.id_board = b.id_board AND lb.id_member = {int:current_member})]]></search>
		<add><![CDATA[INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[AND b.id_board != {int:recycle_board}' : '') . ']]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['current_member' => $user_info['id'],
			'recycle_board' => (int) $modSettings['recycle_board'],]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $db_prefix, $txt, $scripturl, $user_info, $modSettings, $smcFunc, $context]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[SELECT id_topic
			FROM {db_prefix}topics
			WHERE num_' . ($type != 'replies' ? 'views' : 'replies') . ' != 0' . ($modSettings['postmod_active'] ? '
				AND approved = {int:is_approved}' : '') . '
			ORDER BY num_' . ($type != 'replies' ? 'views' : 'replies') . ' DESC
			LIMIT {int:limit}',
			array(
				'is_approved' => 1,
				'limit' => $num_topics > 100 ? ($num_topics + ($num_topics / 2)) : 100,
			)]]></search>
		<add><![CDATA[SELECT t.id_topic
			FROM {db_prefix}topics AS t
				INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
				INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			WHERE t.num_' . ($type != 'replies' ? 'views' : 'replies') . ' != 0' . ($modSettings['postmod_active'] ? '
				AND t.approved = {int:is_approved}' : '') . '
				AND c.forumid = {int:forumid}
			ORDER BY num_' . ($type != 'replies' ? 'views' : 'replies') . ' DESC
			LIMIT {int:limit}',
			array(
				'is_approved' => 1,
				'limit' => $num_topics > 100 ? ($num_topics + ($num_topics / 2)) : 100,
				'forumid' => (int) $forumid,
			)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}messages AS m ON (m.id_msg = t.id_first_msg)
			INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[AND t.id_topic IN ({array_int:topic_list})' : '') . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND b.id_board != {int:recycle_enable}' : '') . ']]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['recycle_enable' => $modSettings['recycle_board'],
			'limit' => $num_topics,]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $db_prefix, $txt, $scripturl, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$totals = array(
		'members' => $modSettings['totalMembers'],
		'posts' => $modSettings['totalMessages'],
		'topics' => $modSettings['totalTopics']
	);

	$result = $smcFunc['db_query']('', '
		SELECT COUNT(*)
		FROM {db_prefix}boards',
		array(
		)
	);
	list ($totals['boards']) = $smcFunc['db_fetch_row']($result);
	$smcFunc['db_free_result']($result);

	$result = $smcFunc['db_query']('', '
		SELECT COUNT(*)
		FROM {db_prefix}categories',
		array(
		)]]></search>
		<add><![CDATA[$result = $smcFunc['db_query']('', '
		SELECT COUNT(b.id_board) AS boards, SUM(b.num_topics) AS topics, SUM(b.num_posts) AS posts
		FROM {db_prefix}boards AS b
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE c.forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,
		)
	);
	$row = $smcFunc['db_fetch_assoc']($result);
	$totals = array(
		'members' => $modSettings['totalMembers'],
		'boards' => $row['boards'],
		'topics' => $row['topics'],
		'posts' => $row['posts'],
	);
	$smcFunc['db_free_result']($result);

	$result = $smcFunc['db_query']('', '
		SELECT COUNT(*)
		FROM {db_prefix}categories AS c
		WHERE c.forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,
		)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[function ssi_recentPoll($topPollInstead = false, $output_method = 'echo')
{
	global $db_prefix, $txt, $settings, $boardurl, $user_info, $context, $smcFunc, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)' . ($topPollInstead ? ']]></search>
		<add><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)' . ($topPollInstead ? ']]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[AND b.id_board IN ({array_int:boards_allowed_list})' : '') . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND b.id_board != {int:recycle_enable}' : '') . ']]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['current_time' => time(),
			'recycle_enable' => $modSettings['recycle_board'],]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[function ssi_showPoll($topic = null, $output_method = 'echo')
{
	global $db_prefix, $txt, $settings, $boardurl, $user_info, $context, $smcFunc, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
		WHERE t.id_topic = {int:current_topic}]]></search>
		<add><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE t.id_topic = {int:current_topic}
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['boards_allowed_see' => $boardsAllowed,]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[function ssi_pollVote()
{
	global $context, $db_prefix, $user_info, $sc, $smcFunc, $sourcedir, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}topics AS t ON (t.id_poll = {int:current_poll})
			INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[WHERE p.id_poll = {int:current_poll}]]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['current_poll' => $_POST['poll'],
			'is_approved' => 1,]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $scripturl, $db_prefix, $txt, $settings, $modSettings, $context]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[SELECT id_board
		FROM {db_prefix}boards
		WHERE ' . ($board === null ? '' : 'id_board = {int:current_board}
			AND ') . 'FIND_IN_SET(-1, member_groups) != 0
		LIMIT 1',
		array(
			'current_board' => $board,
		)]]></search>
		<add><![CDATA[SELECT b.id_board
		FROM {db_prefix}boards AS b
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE ' . ($board === null ? '' : 'id_board = {int:current_board}
			AND ') . 'FIND_IN_SET(-1, member_groups) != 0
			AND c.forumid = {int:forumid}
		LIMIT 1',
		array(
			'current_board' => $board,
			'forumid' => (int) $forumid,
		)]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[SELECT t.id_first_msg
		FROM {db_prefix}topics as t
		LEFT JOIN {db_prefix}boards as b ON (b.id_board = t.id_board)
		WHERE t.id_board = {int:current_board}' . ($modSettings['postmod_active'] ? '
			AND t.approved = {int:is_approved}' : '') . '
			AND {query_see_board}
		ORDER BY t.id_first_msg DESC
		LIMIT ' . $start . ', ' . $limit,
		array(
			'current_board' => $board,
			'is_approved' => 1,
		)]]></search>
		<add><![CDATA[SELECT t.id_first_msg
		FROM {db_prefix}topics as t
			LEFT JOIN {db_prefix}boards as b ON (b.id_board = t.id_board)
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE t.id_board = {int:current_board}' . ($modSettings['postmod_active'] ? '
			AND t.approved = {int:is_approved}' : '') . '
			AND {query_see_board}
			AND c.forumid = {int:forumid}
		ORDER BY t.id_first_msg DESC
		LIMIT ' . $start . ', ' . $limit,
		array(
			'current_board' => $board,
			'is_approved' => 1,
			'forumid' => (int) $forumid,
		)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $smcFunc, $context, $modSettings, $scripturl, $txt, $settings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}topics AS t ON (t.id_topic = m.id_topic)]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[AND att.approved = {int:is_approved}') . '
		ORDER BY att.id_attach DESC
		LIMIT {int:num_attachments}',
		array(
			'boards_can_see' => $attachments_boards,]]></search>
		<add><![CDATA[AND att.approved = {int:is_approved}') . '
			AND c.forumid = {int:forumid}
		ORDER BY att.id_attach DESC
		LIMIT {int:num_attachments}',
		array(
			'forumid' => (int) $forumid,
			'boards_can_see' => $attachments_boards,]]></add>
	</operation>
</file>
<file name="$sourcedir/Display.php">
	<operation>
		<search position="before"><![CDATA[global $scripturl, $txt, $modSettings, $context, $settings]]></search>
		<add><![CDATA[, $forumid;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[WHERE cal.id_topic = {int:current_topic}
			ORDER BY start_date',
			array(
				'current_topic' => $topic,]]></search>
		<add><![CDATA[WHERE cal.id_topic = {int:current_topic}
				AND cal.forumid = {int:forumid}
			ORDER BY start_date',
			array(
				'current_topic' => $topic,
				'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Load.php">
	<operation>
		<search position="before"><![CDATA[global $context, $settings, $options, $sourcedir, $ssi_theme, $smcFunc]]></search>
		<add><![CDATA[, $subtheme, $forumid]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[// The theme was specified by parameter.]]></search>
		<add><![CDATA[// Load subforum theme if we are in one.
	if (!empty($forumid) && empty($id_theme))
		$id_theme = $subtheme;

	]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $txt, $scripturl, $context, $modSettings]]></search>
		<add><![CDATA[, $subtheme, $forumid, $boardurl]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[b.id_parent, c.name AS cname,]]></search>
		<add><![CDATA[b.id_parent, c.name AS cname, c.forumid,]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[if (empty($temp))]]></search>
		<add><![CDATA[retry_board_info:
	]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[// Set the current board.]]></search>
		<add><![CDATA[// Find the right subforum to redirect to:
			if (!empty($row['alias_board']) && empty($temp_board))
			{
				$temp_board = array('blegh' => 0);
				$board = $row['alias_board'];
				$smcFunc['db_free_result']($request);
				goto retry_board_info;
			}
			if ($row['forumid'] != $forumid && empty($temp_board))
			{
				// Try to get the board alias if the Alias Boards mod is installed:
				if (isset($row['alias_board']))
				{
					$request2 = $smcFunc['db_query']('', '
						SELECT b.id_cat, b.id_board, b.id_parent, b.name AS bname, c.name AS cname, b.description
						FROM {db_prefix}boards AS b
							LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
						WHERE b.alias_board = {int:board}
							AND c.forumid = {int:forumid}
						LIMIT 1',
						array(
							'board' => empty($board) ? $row['id_board'] : $board,
							'forumid' => (int) $forumid,
						)
					);
					if ($smcFunc['db_num_rows']($request2) > 0)
					{
						$temp_board = $smcFunc['db_fetch_assoc']($request2);
						$smcFunc['db_free_result']($request2);
					}
				}
				if (empty($temp_board))
				{
					// If the "subforum_redirect_wrong" variable is set and $sub isn't empty, then redirect:
					$sub = (isset($subforum_tree[(int) $row['forumid']]) ? $subforum_tree[(int) $row['forumid']] : 0);
					if (!empty($modSettings['subforum_redirect_wrong']) && (!empty($sub)))
					{
						$url = (empty($_SERVER['HTTPS']) || $_SERVER['HTTPS'] == 'off' ? 'http://' : 'https://') . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];
						redirectexit(str_replace($boardurl, $sub['boardurl'], $url));
					}

					// Throw error about wrong forum:
					loadPermissions();
					loadTheme();
					fatal_lang_error('wrong_forum', false);
				}
			}

			]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[// Set the current board.]]></search>
		<add><![CDATA[
			if (!empty($temp_board))
				$row = array_merge($row, $temp_board, array('redirect' => ''));]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $board_info, $board, $topic, $user_info, $smcFunc]]></search>
		<add><![CDATA[, $subforum_tree]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageBoards.php">
	<operation>
		<search position="replace"><![CDATA[$_REQUEST['cat'] = isset($_REQUEST['cat']) ? (int) $_REQUEST['cat'] : 0;]]></search>
		<add><![CDATA[$_REQUEST['cat'] = isset($_REQUEST['cat']) ? (int) $_REQUEST['cat'] : 0;
	$_REQUEST['sub'] = isset($_REQUEST['sub']) ? (int) $_REQUEST['sub'] : 0;]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $context, $txt, $sourcedir, $modSettings, $scripturl, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE redirect = {string:empty_string}',
		array(]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})
		WHERE redirect = {string:empty_string}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['can_collapse' => true,]]></search>
		<add><![CDATA[
			'forumid' => (!empty($_REQUEST['sub']) ? $_REQUEST['sub'] : 0),]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['can_collapse' => !empty($cat_tree[$_REQUEST['cat']]['node']['can_collapse']),]]></search>
		<add><![CDATA[
			'forumid' => (int)($cat_tree[$_REQUEST['cat']]['node']['forumid']),]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[$catOptions['is_collapsible'] = isset($_POST['collapse']);]]></search>
		<add><![CDATA[
		$catOptions['forumid'] = (int)($_POST['forum_id']);]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $txt, $context, $cat_tree, $boards, $boardList, $scripturl, $sourcedir, $txt]]></search>
		<add><![CDATA[, $boardurl, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$context['categories'][$catid] = array(]]></search>
		<add><![CDATA[$context['categories'][$catid] = array(
			'forumid' => $tree['node']['forumid'],]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[}
	// Category doesn't exist, man... sorry.
	elseif (!isset($cat_tree[$_REQUEST['cat']]))
		redirectexit('action=admin;area=manageboards');]]></search>
		<add><![CDATA[}
	// Category doesn't exist, man... sorry.
	elseif (!isset($cat_tree[$_REQUEST['cat']]))
		redirectexit('action=admin;area=manageboards' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : ''));]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[redirectexit('action=admin;area=manageboards');
}

// Modify a specific board...
function EditBoard()
{
	global $txt, $context, $cat_tree, $boards, $boardList, $sourcedir, $smcFunc, $modSettings;

	loadTemplate('ManageBoards');
	require_once($sourcedir . '/Subs-Boards.php');
	getBoardTree();]]></search>
		<add><![CDATA[redirectexit('action=admin;area=manageboards' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : ''));
}

// Modify a specific board...
function EditBoard()
{
	global $txt, $context, $cat_tree, $boards, $boardList, $sourcedir, $smcFunc, $modSettings, $forumid, $subforum_tree;

	loadTemplate('ManageBoards');
	require_once($sourcedir . '/Subs-Boards.php');
	getBoardTree( ($forumid == 0 ? -1 : $forumid) );]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[if ($_REQUEST['sa'] == 'newboard')
	{
		// Category doesn't exist, man... sorry.
		if (empty($_REQUEST['cat']))
			redirectexit('action=admin;area=manageboards');]]></search>
		<add><![CDATA[if ($_REQUEST['sa'] == 'newboard')
	{
		// Category doesn't exist, man... sorry.
		if (empty($_REQUEST['cat']))
			redirectexit('action=admin;area=manageboards' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : ''));]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Category doesn't exist, man... sorry.
	if (!isset($boardList[$curBoard['category']]))
		redirectexit('action=admin;area=manageboards');

	foreach ($boardList[$curBoard['category']] as $boardid)
	{
		if ($boardid == $_REQUEST['boardid'])
		{
			$context['board_order'][] = array(
				'id' => $boardid,
				'name' => str_repeat('-', $boards[$boardid]['level']) . ' (' . $txt['mboards_current_position'] . ')',
				'children' => $boards[$boardid]['tree']['children'],
				'no_children' => empty($boards[$boardid]['tree']['children']),
				'is_child' => false,
				'selected' => true
			);
		}
		else
		{
			$context['board_order'][] = array(
				'id' => $boardid,
				'name' => str_repeat('-', $boards[$boardid]['level']) . ' ' . $boards[$boardid]['name'],
				'is_child' => empty($_REQUEST['boardid']) ? false : isChildOf($boardid, $_REQUEST['boardid']),
				'selected' => false
			);
		}
	}]]></search>
		<add><![CDATA[// Category doesn't exist, man... sorry.
	if (!isset($boardList[$curBoard['category']]))
		redirectexit('action=admin;area=manageboards' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : ''));

	$selected_cat = -1;
	foreach ($boardList as $cat => $list)
	{
		$context['board_order'][$cat] = array();
		foreach ($list as $boardid)
		{
			if ($boardid == $_REQUEST['boardid'])
			{
				$context['board_order'][$cat][] = array(
					'id' => $boardid,
					'name' => str_repeat('-', $boards[$boardid]['level']) . ' (' . $txt['mboards_current_position'] . ')',
					'children' => $boards[$boardid]['tree']['children'],
					'no_children' => empty($boards[$boardid]['tree']['children']),
					'is_child' => false,
					'selected' => true
				);
				$selected_cat = $cat;
			}
			else
			{
				$context['board_order'][$cat][] = array(
					'id' => $boardid,
					'name' => str_repeat('-', $boards[$boardid]['level']) . ' ' . $boards[$boardid]['name'],
					'is_child' => empty($_REQUEST['boardid']) ? false : isChildOf($boardid, $_REQUEST['boardid']),
					'selected' => false
				);
			}
		}
	}
	foreach ($context['board_order'] as $cat => $boards2)
	{
		if ($selected_cat != $cat && !empty($context['board_order'][$cat][0]['selected']))
			$context['board_order'][$cat][0]['selected'] = true;
	}]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[if (isset($_REQUEST['rid']) && $_REQUEST['rid'] == 'permissions')
		redirectexit('action=admin;area=permissions;sa=board;' . $context['session_var'] . '=' . $context['session_id']);
	else
		redirectexit('action=admin;area=manageboards');]]></search>
		<add><![CDATA[if (isset($_REQUEST['rid']) && $_REQUEST['rid'] == 'permissions')
		redirectexit('action=admin;area=permissions;sa=board' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : '') . ';' . $context['session_var'] . '=' . $context['session_id']);
	else
		redirectexit('action=admin;area=manageboards' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : ''));]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[function EditCategory()
{
	global $txt, $context, $cat_tree, $boardList, $boards, $sourcedir;

	loadTemplate('ManageBoards');
	require_once($sourcedir . '/Subs-Boards.php');
	getBoardTree();]]></search>
		<add><![CDATA[function EditCategory()
{
	global $txt, $context, $cat_tree, $boardList, $boards, $sourcedir, $forumid, $subforum_tree;

	loadTemplate('ManageBoards');
	require_once($sourcedir . '/Subs-Boards.php');
	getBoardTree( ($forumid == 0 ? -1 : $forumid) );]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[getBoardTree();

	$context['move_board'] = !empty($_REQUEST['move']) && isset($boards[(int) $_REQUEST['move']]) ? (int) $_REQUEST['move'] : 0;]]></search>
		<add><![CDATA[getBoardTree( ($forumid == 0 ? -1 : $forumid) );

	$context['move_board'] = !empty($_REQUEST['move']) && isset($boards[(int) $_REQUEST['move']]) ? (int) $_REQUEST['move'] : 0;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Start with one - "In first place".
	$context['category_order'] = array(
		array(
			'id' => 0,
			'name' => $txt['mboards_order_first'],
			'selected' => !empty($_REQUEST['cat']) ? $cat_tree[$_REQUEST['cat']]['is_first'] : false,
			'true_name' => ''
		)
	);]]></search>
		<add><![CDATA[// Start with one - "In first place".
	$context['category_order'] = array();
	foreach ($subforum_tree as $stuff)
		$context['category_order'][$stuff['forumid']] = array(
			array(
				'id' => 0,
				'name' => $txt['mboards_order_first'],
				'selected' => !empty($_REQUEST['cat']) ? $cat_tree[$_REQUEST['cat']]['is_first'] : false,
				'true_name' => ''
			)
		);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$context['category_order'][$prevCat]['selected'] = true;
		elseif ($catid != $_REQUEST['cat'])
			$context['category_order'][$catid] = array(]]></search>
		<add><![CDATA[$context['category_order'][$tree['node']['forumid']][$prevCat]['selected'] = true;
		elseif ($catid != $_REQUEST['cat'])
			$context['category_order'][$tree['node']['forumid']][$catid] = array(
				'forumid' => $tree['node']['forumid'],]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[if (isset($_POST['cat_order']))
			$catOptions['move_after'] = (int) $_POST['cat_order'];]]></search>
		<add><![CDATA[if (isset($_POST['cat_order' . ((int) $_POST['forum_id'])]))
			$catOptions['move_after'] = (int) $_POST['cat_order' . ((int) $_POST['forum_id'])];]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[foreach ($cat_tree as $catID => $tree)
		$context['categories'][] = array(]]></search>
		<add><![CDATA[foreach ($subforum_tree as $subforum)
		$context['categories'][$subforum['forumid']] = array();
	foreach ($cat_tree as $catID => $tree)
		$context['categories'][$tree['node']['forumid']][] = array(]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $txt, $sourcedir, $modSettings, $smcFunc, $context]]></search>
		<add><![CDATA[, $forumid, $subforum_tree]]></add>
	</operation>
	<operation>
		<search positon="replace"><![CDATA[$boardOptions = array();

		// Move this board to a new category?
		if (!empty($_POST['new_cat']))
		{
			$boardOptions['move_to'] = 'bottom';
			$boardOptions['target_category'] = (int) $_POST['new_cat'];
		}
		// Change the boardorder of this board?
		elseif (!empty($_POST['placement']) && !empty($_POST['board_order']))
		{
			if (!in_array($_POST['placement'], array('before', 'after', 'child')))
				fatal_lang_error('mangled_post', false);

			$boardOptions['move_to'] = $_POST['placement'];
			$boardOptions['target_board'] = (int) $_POST['board_order'];]]></search>
		<add><![CDATA[$boardOptions = array();
		$sub = (isset($_POST['new_forum']) ? $_POST['new_forum'] : $forumid);
		$cat = (isset($_POST['new_cat' . $sub]) ? $_POST['new_cat' . $sub] : '');
		
		// Move this board to a new category?
		if (!empty($cat))
		{
			$boardOptions['move_to'] = 'bottom';
			$boardOptions['target_category'] = $cat;
		}			
			
		// Change the boardorder of this board?
		$cat = (!empty($cat) ? $cat : (isset($_POST['current_cat']) ? $_POST['current_cat'] : ''));
		if (!empty($_POST['placement' . $cat]) && !empty($_POST['board_order' . $cat]))
		{
			if (!in_array($_POST['placement' . $cat], array('before', 'after', 'child')))
				fatal_lang_error('mangled_post', false);

			$boardOptions['move_to'] = $_POST['placement' . $cat];
			$boardOptions['target_board'] = (int) $_POST['board_order' . $cat];]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$context['children'] = $boards[$_REQUEST['boardid']]['tree']['children'];
		foreach ($context['board_order'] as $board)
			if ($board['is_child'] == false && $board['selected'] == false)
				$context['can_move_children'] = true;]]></search>
		<add><![CDATA[if (isset($boards[$_REQUEST['boardid']]['tree']['children']))
			$context['children'] = $boards[$_REQUEST['boardid']]['tree']['children'];
		else
			$context['children'] = array();
		foreach ($context['board_order'] as $cat => $list)
			foreach ($list as $board)
				if ($board['is_child'] == false && $board['selected'] == false)
					$context['can_move_children'] = true;]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageCalendar.php">
	<operation>
		<search position="before"><![CDATA[global $modSettings, $context, $settings, $txt, $boarddir, $sourcedir, $scripturl, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)',
		array(]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageMembergroups.php">
	<operation>
		<search position="before"><![CDATA[function AddMembergroup()
{
	global $context, $txt, $sourcedir, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $subforum_tree, $forumid]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[// A form was submitted, we can start adding.]]></search>
		<add><![CDATA[// Restrict user to editing current subforum ONLY if we are in a subforum:
	if (!empty($forumid))
		$subforum_tree = array($forumid => $subforum_tree[$forumid]);
	
	]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[SELECT id_board, name, child_level
		FROM {db_prefix}boards
		ORDER BY board_order]]></search>
		<add><![CDATA[SELECT b.id_board, b.name, b.child_level, c.forumid
		FROM {db_prefix}boards AS b
			LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		ORDER BY c.forumid, b.board_order]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['selected' => false]]></search>
		<add><![CDATA[,
			'forumid' => $row['forumid']]]></add>
	</operation>

	<operation>
		<search position="before"><![CDATA[function EditMembergroup()
{
	global $context, $txt, $sourcedir, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $subforum_tree, $forumid]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[// Make sure this group is editable.]]></search>
		<add><![CDATA[// Restrict user to editing current subforum ONLY if we are in a subforum:
	if (!empty($forumid))
		$subforum_tree = array($forumid => $subforum_tree[$forumid]);
	
	]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[SELECT id_board, name, child_level, FIND_IN_SET({string:current_group}, member_groups) != 0 AS can_access
			FROM {db_prefix}boards
			ORDER BY board_order]]></search>
		<add><![CDATA[SELECT b.id_board, b.name, b.child_level, FIND_IN_SET({string:current_group}, b.member_groups) != 0 AS can_access, c.forumid
			FROM {db_prefix}boards AS b
				LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			ORDER BY c.forumid, b.board_order]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['selected' => !(empty($row['can_access']) || $row['can_access'] == 'f'),]]></search>
		<add><![CDATA[
				'forumid' => $row['forumid'],]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageNews.php">
	<operation>
		<search position="before"><![CDATA[global $txt, $modSettings, $context, $sourcedir, $user_info]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[require_once($sourcedir . '/Subs-Post.php');]]></search>
		<add><![CDATA[require_once($sourcedir . '/Subs-Post.php');
		$tmp = (empty($forumid) ? '' : $forumid);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$temp_news = explode("\n", $modSettings['news']);]]></search>
		<add><![CDATA[$temp_news = explode("\n", $modSettings['news' . $tmp]);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[updateSettings(array('news' => implode("\n", $temp_news)));]]></search>
		<add><![CDATA[updateSettings(array('news' . $tmp => implode("\n", $temp_news)));]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[updateSettings(array('news' => implode("\n", $_POST['news'])));]]></search>
		<add><![CDATA[updateSettings(array('news' . $tmp => implode("\n", $_POST['news'])));]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[foreach (explode("\n", $modSettings['news']) as $id => $line)]]></search>
		<add><![CDATA[foreach (explode("\n", $modSettings['news' . $tmp]) as $id => $line)]]></add>
	</operation>
</file>
<file name="$sourcedir/ManagePermissions.php">
	<operation>
		<search position="before"><![CDATA[function PermissionByBoard()
{
	global $context, $modSettings, $txt, $smcFunc, $sourcedir, $cat_tree, $boardList, $boards]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[getBoardTree();]]></search>
		<add><![CDATA[getBoardTree( ($forumid == 0 ? -1 : $forumid) );]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$context['categories'][$catid] = array(]]></search>
		<add><![CDATA[$id = $cat_tree[$catid]['node']['forumid'];
		$context['categories'][$id][$catid] = array(]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$context['categories'][$catid]['boards'][$boardid] = array(]]></search>
		<add><![CDATA[$context['categories'][$id][$catid]['boards'][$boardid] = array(]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageRegistration.php">
	<operation>
		<search position="before"><![CDATA[global $txt, $context, $scripturl, $modSettings, $sourcedir]]></search>
		<add><![CDATA[, $smcFunc]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[$config_vars = array(]]></search>
		<add><![CDATA[// Build an array for the membergroup list:
    loadLanguage('Profile');
	$group_list = array($txt['admin_register_group_none']);
	$request = $smcFunc['db_query']('', '
		SELECT group_name, id_group, min_posts
		FROM {db_prefix}membergroups
		WHERE id_group > {int:moderator_group}
		ORDER BY min_posts, group_name',
		array(
			'moderator_group' => 3,
		)
	);
    while ($row = $smcFunc['db_fetch_assoc']($request))
		if ($row['min_posts'] != -1) $group_list[$row['id_group']] = $row['group_name'];
    $smcFunc['db_free_result']($request);

	]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[array('check', 'send_welcomeEmail'),]]></search>
		<add><![CDATA[array('check', 'send_welcomeEmail'),
			array('select', 'primary_membergroup', $group_list),]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $txt, $boarddir, $context, $modSettings, $smcFunc, $settings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Try to figure out if we have more agreements.
	foreach ($context['languages'] as $lang)
	{
		if (file_exists($boarddir . '/agreement.' . $lang['filename'] . '.txt'))
		{
			$context['editable_agreements']['.' . $lang['filename']] = $lang['name'];
			// Are we editing this?
			if (isset($_POST['agree_lang']) && $_POST['agree_lang'] == '.' . $lang['filename'])
				$context['current_agreement'] = '.' . $lang['filename'];
		}
	}

	if (isset($_POST['agreement']))
	{
		checkSession();

		// Off it goes to the agreement file.
		$fp = fopen($boarddir . '/agreement' . $context['current_agreement'] . '.txt', 'w');
		fwrite($fp, str_replace("\r", '', $_POST['agreement']));
		fclose($fp);

		updateSettings(array('requireAgreement' => !empty($_POST['requireAgreement'])));
	}

	$context['agreement'] = file_exists($boarddir . '/agreement' . $context['current_agreement'] . '.txt') ? htmlspecialchars(file_get_contents($boarddir . '/agreement' . $context['current_agreement'] . '.txt')) : '';
	$context['warning'] = is_writable($boarddir . '/agreement' . $context['current_agreement'] . '.txt') ? '' : $txt['agreement_not_writable'];]]></search>
		<add><![CDATA[// Try to figure out if we have more agreements.
	$agree = 'agreement' . ($forumid == 0 ? '' : '.forum' . $forumid) . '.';
	foreach ($context['languages'] as $lang)
	{
		if (file_exists($boarddir . '/' . $agree . $lang['filename'] . '.txt'))
		{
			$context['editable_agreements']['.' . $lang['filename']] = $lang['name'];
			// Are we editing this?
			if (isset($_POST['agree_lang']) && $_POST['agree_lang'] == '.' . $lang['filename'])
				$context['current_agreement'] = '.' . $lang['filename'];
		}
	}

	if (isset($_POST['agreement']))
	{
		checkSession();

		// Off it goes to the agreement file.
		$fp = fopen($boarddir . '/' . $agree . $context['current_agreement'] . '.txt', 'w');
		fwrite($fp, str_replace("\r", '', $_POST['agreement']));
		fclose($fp);

		updateSettings(array('requireAgreement' => !empty($_POST['requireAgreement'])));
	}

	$context['agreement'] = file_exists($boarddir . '/' . $agree . $context['current_agreement'] . '.txt') ? htmlspecialchars(file_get_contents($boarddir . '/' . $agree . $context['current_agreement'] . '.txt')) : '';
	$context['warning'] = is_writable($boarddir . '/' . $agree . $context['current_agreement'] . '.txt') ? '' : $txt['agreement_not_writable'];]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageServer.php">
	<operation>
		<search position="replace"><![CDATA[array('cachedir', $txt['cachedir'], 'file', 'text', 36),]]></search>
		<add><![CDATA[array('cachedir', $txt['cachedir'], 'file', 'text', 36),
		array('favicon', $txt['favicon'], 'file', 'text', 36),]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA['boarddir', 'sourcedir', 'cachedir',]]></search>
		<add><![CDATA['boarddir', 'sourcedir', 'cachedir', 'favicon',]]></add>
	</operation>
</file>
<file name="$sourcedir/MoveTopic.php">
    <operation>
        <search position="before"><![CDATA[global $txt, $board, $topic, $user_info, $context, $language, $scripturl, $settings, $smcFunc, $modSettings]]></search>
        <add><![CDATA[, $forumid]]></add>
    </operation>
	<operation>
		<search position="before"><![CDATA[SELECT b.id_board, b.name, b.child_level, c.name AS cat_name, c.id_cat]]></search>
		<add><![CDATA[, c.forumid]]></add>
	</operation>
    <operation>
        <search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></search>
        <add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})]]></add>
    </operation>
	<operation>
		<search position="before"><![CDATA[WHERE {query_see_board}
			AND b.redirect = {string:blank_redirect}]]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
    <operation>
        <search position="before"><![CDATA['blank_redirect' => '',
			'current_board' => $board,]]></search>
        <add><![CDATA[
            'forumid' => (int) $forumid,]]></add>
    </operation>
</file>
<file name="$sourcedir/News.php">
	<operation>
		<search position="before"><![CDATA[function getXmlNews($xml_format)
{
	global $user_info, $scripturl, $modSettings, $board]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[function getXmlRecent($xml_format)
{
	global $user_info, $scripturl, $modSettings, $board]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}categories AS c ON (b.id_cat = c.id_cat)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board)]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}categories AS c ON (b.id_cat = c.id_cat)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[AND t.approved = {int:is_approved}' : '') . ']]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[AND m.approved = {int:is_approved}' : '') . ']]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['is_approved' => 1,]]></search>
		<add><![CDATA[
				'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA['current_board' => $board,
				'is_approved' => 1,
				'optimize_msg' => $optimize_msg,]]></search>
		<add><![CDATA['current_board' => $board,
				'is_approved' => 1,
				'optimize_msg' => $optimize_msg,
				'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Packages.php">
	<operation>
		<search position="before"><![CDATA[function Packages()
{
	global $txt, $scripturl, $sourcedir, $context]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[//!!! Remove this!]]></search>
		<add><![CDATA[// Subforum means no packages access
	if ($forumid <> 0)
	{
		isAllowedTo('admin_forum');
		require_once($sourcedir . '/Subs-Package.php');
		loadLanguage('Packages');
		loadTemplate('Packages', 'packages');
		$context[$context['admin_menu_name']]['tab_data'] = array(
			'title' => &$txt['package_manager'],
			'description' => $txt['package_manager_desc'],
			'tabs' => array());
		fatal_lang_error('no_pack_in_subforum', false);
	}

	]]></add>
	</operation>
</file>
<file name="$sourcedir/Post.php">
	<operation>
		<search position="before"><![CDATA[global $txt, $scripturl, $topic, $modSettings, $board]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[FROM {db_prefix}calendar
				WHERE id_event = {int:id_event}
				LIMIT 1',
				array(
					'id_event' => $context['event']['id'],]]></search>
		<add><![CDATA[FROM {db_prefix}calendar
				WHERE id_event = {int:id_event}
					AND forumid = {int:forumid}
				LIMIT 1',
				array(
					'id_event' => $context['event']['id'],
					'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $user_info, $board_info, $options, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Get the event's poster.
			$request = $smcFunc['db_query']('', '
				SELECT id_member
				FROM {db_prefix}calendar
				WHERE id_event = {int:id_event}',
				array(
					'id_event' => $_REQUEST['eventid'],]]></search>
		<add><![CDATA[// Get the event's poster.
			$request = $smcFunc['db_query']('', '
				SELECT id_member
				FROM {db_prefix}calendar
				WHERE id_event = {int:id_event}
					AND forumid = {int:forumid}',
				array(
					'id_event' => $_REQUEST['eventid'],
					'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Delete it?
		if (isset($_REQUEST['deleteevent']))
			$smcFunc['db_query']('', '
				DELETE FROM {db_prefix}calendar
				WHERE id_event = {int:id_event}',
				array(
					'id_event' => $_REQUEST['eventid'],]]></search>
		<add><![CDATA[// Delete it?
		if (isset($_REQUEST['deleteevent']))
			$smcFunc['db_query']('', '
				DELETE FROM {db_prefix}calendar
				WHERE id_event = {int:id_event}
					AND forumid = {int:forumid}',
				array(
					'id_event' => $_REQUEST['eventid'],
					'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[WHERE id_event = {int:id_event}',
				array(
					'end_date']]></search>
		<add><![CDATA[WHERE id_event = {int:id_event}
					AND forumid = {int:forumid}',
				array(
					'forumid' => (int) $forumid,
					'end_date']]></add>
	</operation>
</file>
<file name="$sourcedir/PostModeration.php">
	<operation>
		<search position="before"><![CDATA[global $txt, $scripturl, $context, $user_info, $sourcedir, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[LIMIT ' . $context['start'] . ', 10',
		array(
			'not_approved' => 0,
		)]]></search>
		<add><![CDATA[LIMIT ' . $context['start'] . ', 10',
		array(
			'forumid' => (int) $forumid,
			'not_approved' => 0,
		)]]></add>
	</operation>
</file>
<file name="$sourcedir/Profile-Modify.php">
	<operation>
		<search position="before"><![CDATA[global $txt, $user_info, $context, $modSettings, $smcFunc, $cur_profile]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE {query_see_board}
			AND redirect = {string:empty_string}',
		array(]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})
		WHERE {query_see_board}
			AND redirect = {string:empty_string}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Recent.php">
	<operation>
		<search position="before"><![CDATA[global $user_info, $scripturl, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}messages AS ml ON (ml.id_msg = b.id_last_msg)]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}categories AS c ON (b.id_cat = c.id_cat)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[AND ml.approved = {int:is_approved}]]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['recycle_board' => $modSettings['recycle_board'],
			'is_approved' => 1,]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[$sourcedir, $board, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board)]]></search>
		<add><![CDATA[
					INNER JOIN {db_prefix}categories AS c ON (b.id_cat = c.id_cat)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[AND m.approved = {int:is_approved}]]></search>
		<add><![CDATA[
					AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['limit' => 10,]]></search>
		<add><![CDATA[
					'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[$scripturl, $sourcedir]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[		$request = $smcFunc['db_query']('', '
			SELECT b.id_board, b.id_parent
			FROM {db_prefix}boards AS b
			WHERE {query_wanna_see_board}
				AND b.child_level > {int:no_child}
				AND b.id_board NOT IN ({array_int:boards})
			ORDER BY child_level ASC
			',
			array(
				'no_child' => 0,
				'boards' => $boards,
			)
		);]]></search>
		<add><![CDATA[		$request = $smcFunc['db_query']('', '
			SELECT b.id_board, b.id_parent
			FROM {db_prefix}boards AS b
				INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			WHERE {query_wanna_see_board}
				AND b.child_level > {int:no_child}
				AND b.id_board NOT IN ({array_int:boards})' . ($_REQUEST['action'] == 'unreadglobal' ? '' : '
				AND c.forumid = {int:forumid}') . '
			ORDER BY child_level ASC
			',
			array(
				'no_child' => 0,
				'boards' => $boards,
				'forumid' => (int) $forumid,
			)
		);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[		$request = $smcFunc['db_query']('', '
			SELECT b.id_board
			FROM {db_prefix}boards AS b
			WHERE {query_see_board}
				AND b.id_board IN ({array_int:board_list})',
			array(
				'board_list' => $_REQUEST['boards'],
			)
		);]]></search>
		<add><![CDATA[		$request = $smcFunc['db_query']('', '
			SELECT b.id_board
			FROM {db_prefix}boards AS b
				INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			WHERE {query_see_board}
				AND b.id_board IN ({array_int:board_list})' . ($_REQUEST['action'] == 'unreadglobal' ? '' : '
				AND c.forumid = {int:forumid}'),
			array(
				'board_list' => $_REQUEST['boards'],
				'forumid' => (int) $forumid,
			)
		);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[		$request = $smcFunc['db_query']('', '
			SELECT b.id_board
			FROM {db_prefix}boards AS b
			WHERE ' . $user_info[$see_board] . '
				AND b.id_cat IN ({array_int:id_cat})',
			array(
				'id_cat' => $_REQUEST['c'],
			)
		);]]></search>
		<add><![CDATA[		$request = $smcFunc['db_query']('', '
			SELECT b.id_board
			FROM {db_prefix}boards AS b
				INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			WHERE ' . $user_info[$see_board] . '
				AND b.id_cat IN ({array_int:id_cat})' . ($_REQUEST['action'] == 'unreadglobal' ? '' : '
				AND c.forumid = {int:forumid}'),
			array(
				'id_cat' => $_REQUEST['c'],
				'forumid' => (int) $forumid,
			)
		);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[		$request = $smcFunc['db_query']('', '
			SELECT b.id_board
			FROM {db_prefix}boards AS b
			WHERE ' . $user_info[$see_board] . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
				AND b.id_board != {int:recycle_board}' : ''),
			array(
				'recycle_board' => (int) $modSettings['recycle_board'],
			)
		);]]></search>
		<add><![CDATA[		$request = $smcFunc['db_query']('', '
			SELECT b.id_board
			FROM {db_prefix}boards AS b
				INNER JOIN {db_prefix}categories AS c ON (b.id_cat = c.id_cat)
			WHERE ' . $user_info[$see_board] . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
				AND b.id_board != {int:recycle_board}' : '') . ($_REQUEST['action'] == 'unreadglobal' ? '' : '
				AND c.forumid = {int:forumid}'),
			array(
				'recycle_board' => (int) $modSettings['recycle_board'],
				'forumid' => (int) $forumid
			)
		);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$txt['unread_topics_visit_none'] = strtr($txt['unread_topics_visit_none'], array('?action=unread;all' => '?action=unread;all' . sprintf($context['querystring_board_limits'], 0) . $context['querystring_sort_limits']));]]></search>
		<add><![CDATA[$txt['unread_topics_visit_none'] = strtr($txt['unread_topics_visit_none'], array('?action=unread;all' => '?action=' . ($_REQUEST['action'] == 'unreadglobal' ? 'unreadglobal' : 'unread') . ';all' . sprintf($context['querystring_board_limits'], 0) . $context['querystring_sort_limits']));]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[WHERE id_cat = {int:id_cat}
				LIMIT 1',
				array(]]></search>
		<add><![CDATA[WHERE id_cat = {int:id_cat}
					AND forumid = {int:forumid}
				LIMIT 1',
				array(
					'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[FROM {db_prefix}boards AS b
			WHERE b.id_cat IN ({array_int:category_list})
				AND {query_see_board}',
			array(
				'category_list' => $_REQUEST['c'],]]></search>
		<add><![CDATA[FROM {db_prefix}boards AS b
				LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			WHERE b.id_cat IN ({array_int:category_list})
				AND c.forumid = {int:forumid}
				AND {query_see_board}',
			array(
				'forumid' => (int) $forumid,
				'category_list' => $_REQUEST['c'],]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[FROM {db_prefix}boards AS b
			WHERE b.id_board IN ({array_int:board_list})
				AND {query_see_board}
			LIMIT {int:limit}',
			array(
				'board_list' => $_REQUEST['boards'],]]></search>
		<add><![CDATA[FROM {db_prefix}boards AS b
				LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			WHERE b.id_board IN ({array_int:board_list})
				AND c.forumid = {int:forumid}
				AND {query_see_board}
			LIMIT {int:limit}',
			array(
				'forumid' => (int) $forumid,
				'board_list' => $_REQUEST['boards'],]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[FROM {db_prefix}boards
			WHERE id_board = {int:current_board}
			LIMIT 1',
			array(
				'current_board' => $board,]]></search>
		<add><![CDATA[FROM {db_prefix}boards
				LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			WHERE id_board = {int:current_board}
				AND c.forumid = {int:forumid}
			LIMIT 1',
			array(
				'forumid' => (int) $forumid,
				'current_board' => $board,]]></add>
	</operation>
</file>
<file name="$sourcedir/Register.php">
	<operation>
		<search position="before"><![CDATA[global $txt, $boarddir, $context, $settings, $modSettings, $user_info]]></search>
		<add><![CDATA[, $forumid, $subforum_tree]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Have we got a localized one?
		if (file_exists($boarddir . '/agreement.' . $user_info['language'] . '.txt'))
			$context['agreement'] = parse_bbc(file_get_contents($boarddir . '/agreement.' . $user_info['language'] . '.txt'), true, 'agreement_' . $user_info['language']);
		elseif (file_exists($boarddir . '/agreement.txt'))
			$context['agreement'] = parse_bbc(file_get_contents($boarddir . '/agreement.txt'), true, 'agreement');]]></search>
		<add><![CDATA[// Have we got a localized one?
		$agree = 'agreement' . ($forumid == 0 ? '' : '.forum' . $forumid) . '.';
		if (file_exists($boarddir . '/' . $agree . $user_info['language'] . '.txt'))
			$context['agreement'] = parse_bbc(file_get_contents($boarddir . '/' . $agree . $user_info['language'] . '.txt'), true, 'agreement_' . $user_info['language']);
		elseif (file_exists($boarddir . '/' . $agree . '.txt'))
			$context['agreement'] = parse_bbc(file_get_contents($boarddir . '/' . $agree . '.txt'), true, 'agreement');]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Do we need them to agree to the registration agreement, first?]]></search>
		<add><![CDATA[// If admin requires registration to be redirected to the primary forum, do so now:
	if (!empty($modSettings['subforum_settings_register_at_primary']) && $forumid != 0)
		redirectExit($subforum_tree[0]['boardurl'] . '/index.php?action=register');
	
	// Do we need them to agree to the registration agreement, first?]]></add>
	</operation>
</file>
<file name="$sourcedir/RemoveTopic.php">
	<operation>
		<search position="before"><![CDATA[global $sourcedir, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[DELETE FROM {db_prefix}calendar
		WHERE id_topic IN ({array_int:topics})',
		array(
			'topics' => $topics,]]></search>
		<add><![CDATA[DELETE FROM {db_prefix}calendar
		WHERE id_topic IN ({array_int:topics})
			AND forumid = {int:forumid}',
		array(
			'topics' => $topics,
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Reports.php">
	<operation>
		<search position="before"><![CDATA[global $context, $txt, $sourcedir, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA['name' => 'name',]]></search>
		<add><![CDATA['name' => 'name',
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Search.php">
	<operation>
		<search position="before"><![CDATA[global $txt, $scripturl, $modSettings, $user_info, $context, $smcFunc, $sourcedir]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[SELECT b.id_cat, c.name AS cat_name, b.id_board, b.name, b.child_level]]></search>
		<add><![CDATA[SELECT b.id_cat, c.name AS cat_name, c.forumid, b.id_board, b.name, b.child_level]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[// This category hasn't been set up yet..]]></search>
		<add><![CDATA[		if ((int)$row['forumid'] != $forumid) // non-viewable board
			continue;
]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $scripturl, $modSettings, $sourcedir, $txt, $db_connection]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></search>
		<add><![CDATA[INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA['message_list' => $msg_list,
				'is_approved' => 1,]]></search>
		<add><![CDATA['message_list' => $msg_list,
				'is_approved' => 1,
				'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/SplitTopics.php">
	<operation>
		<search position="before"><![CDATA[global $smcFunc, $language, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[UPDATE {db_prefix}calendar
		SET
			id_topic = {int:id_topic},
			id_board = {int:target_board}
		WHERE id_topic IN ({array_int:deleted_topics})',
		array(]]></search>
		<add><![CDATA[UPDATE {db_prefix}calendar
		SET
			id_topic = {int:id_topic},
			id_board = {int:target_board}
		WHERE id_topic IN ({array_int:deleted_topics})
			AND forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs.php">
	<operation>
		<search position="before"><![CDATA[function setupMenuContext()
{
	global $context, $modSettings, $user_info, $txt, $scripturl]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA['href' => $scripturl . '?action=admin;area=packages',
						'show' => allowedTo('admin_forum'),]]></search>
		<add><![CDATA['href' => $scripturl . '?action=admin;area=packages',
						'show' => allowedTo('admin_forum') && ($forumid == 0),]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $user_settings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$context['news_lines'] = explode("\n", str_replace("\r", '', trim(addslashes($modSettings['news']))));]]></search>
		<add><![CDATA[$tmp = (empty($forumid) ? '' : $forumid);
	$context['news_lines'] = explode("\n", str_replace("\r", '', trim(addslashes($modSettings['news' . $tmp]))));]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $user_info, $user_settings, $context, $modSettings, $settings, $topic, $board, $smcFunc, $sourcedir]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$serialized = $_GET + array('USER_AGENT' => $_SERVER['HTTP_USER_AGENT']);]]></search>
		<add><![CDATA[$serialized = $_GET + array('USER_AGENT' => $_SERVER['HTTP_USER_AGENT'], 'forumid' => $forumid);]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Admin.php">
	<operation>
		<search position="after"><![CDATA[// When is Settings.php last changed?]]></search>
		<add><![CDATA[// Put available data in the Subforum Tree variable:
	SplitForum_PreUpdate($config_vars);

	]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-BoardIndex.php">
	<operation>
		<search position="before"><![CDATA[global $settings, $context]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['current_member' => $user_info['id'],]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[// Haven't set this category yet.]]></search>
		<add><![CDATA[// Skip this board, as its category parent is not visible
			if ((int)$row_board['id_cat'] == 0)
				continue;

			]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Boards.php">
	<operation>
		<search position="replace"><![CDATA[// Set moderators of this board.]]></search>
		<add><![CDATA[// Edit the aliases to make sure they are valid for this subforum:
	if (array_key_exists('alias_child', $boardOptions))
	{
		require_once($sourcedir . '/Subs-ManageSplitForums.php');
		remove_bad_aliases();
	}

	// Set moderators of this board.]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $sourcedir, $cat_tree, $boards, $boardList, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Get some basic information about all boards and categories.
	getBoardTree();]]></search>
		<add><![CDATA[// Get some basic information about all boards and categories.
	getBoardTree( ($forumid == 0 ? -1 : $forumid) );]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[function getBoardTree()
{
	global $cat_tree, $boards, $boardList, $txt, $modSettings, $smcFunc]]></search>
		<add><![CDATA[function getBoardTree($reqid = 0)
{
	global $cat_tree, $boards, $boardList, $txt, $modSettings, $smcFunc, $forumid, $subforum_tree]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[// Getting all the board and category information you'd ever wanted.]]></search>
		<add><![CDATA[// Build the subforum tree array:
	if ($forumid <> 0)
		$subforum_tree = array($forumid => $subforum_tree[$forumid]);
	
	// Getting all the board and category information you'd ever wanted.
	$reqid = (int) ($forumid == 0 ? $reqid : $forumid);

	]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$cat_tree = array();
	$boards = array();
	$last_board_order = 0;
	while ($row = $smcFunc['db_fetch_assoc']($request))
	{
		]]></search>
		<add><![CDATA[$cat_tree = array();
	$boards = array();
	$last_board_order = 0;
	while ($row = $smcFunc['db_fetch_assoc']($request))
	{
		if (!isset($subforum_tree[$row['forumid']]))
			$subforum_tree[$row['forumid']] = array('forumid' => (int) $row['forumid']);
			
		]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[
		FROM {db_prefix}categories AS c
			LEFT JOIN {db_prefix}boards AS b ON (b.id_cat = c.id_cat)
		ORDER BY c.cat_order, b.child_level, b.board_order',
		array(]]></search>
		<add><![CDATA[, c.forumid
		FROM {db_prefix}categories AS c
			LEFT JOIN {db_prefix}boards AS b ON (b.id_cat = c.id_cat)
		'.($reqid <> -1 ? 'WHERE c.forumid = {int:forumid}' : '').'
		ORDER BY c.forumid, c.cat_order, b.child_level, b.board_order',
		array(
			'forumid' => (int) $reqid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['can_collapse' => $row['can_collapse']]]></search>
		<add><![CDATA[,
					'forumid' => $row['forumid']]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $sourcedir, $boards, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[DELETE FROM {db_prefix}calendar
		WHERE id_board IN ({array_int:boards_to_remove})',
		array(]]></search>
		<add><![CDATA[DELETE FROM {db_prefix}calendar
		WHERE id_board IN ({array_int:boards_to_remove})
			AND forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[$boards[$row['id_board']] = array(]]></search>
		<add><![CDATA[
				'forumid' => $row['forumid'],]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[getBoardTree();

	// Set the board order for each category.]]></search>
		<add><![CDATA[getBoardTree(-1);

	// Set the board order for each category.]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Calendar.php">
	<operation>
		<search position="before"><![CDATA[global $scripturl, $modSettings, $user_info, $smcFunc, $context]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[AND (cal.id_board = {int:no_board_link} OR {query_wanna_see_board})' : ''),
		array(]]></search>
		<add><![CDATA[AND (cal.id_board = {int:no_board_link} OR {query_wanna_see_board})' : '') .'
			AND cal.forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[global $smcFunc;

	// A simple database query, how hard can that be?
	$request = $smcFunc['db_query']('', '
		SELECT id_member
		FROM {db_prefix}calendar
		WHERE id_event = {int:id_event}
		LIMIT 1',
		array(]]></search>
		<add><![CDATA[global $smcFunc, $forumid;

	// A simple database query, how hard can that be?
	$request = $smcFunc['db_query']('', '
		SELECT id_member
		FROM {db_prefix}calendar
		WHERE id_event = {int:id_event}
			AND forumid = {int:forumid}
		LIMIT 1',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA['start_date' => 'date', 'end_date' => 'date',]]></search>
		<add><![CDATA['start_date' => 'date', 'end_date' => 'date', 'forumid' => 'int',]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[array(
			$eventOptions['board'], $eventOptions['topic'], $eventOptions['title'], $eventOptions['member'],
			$eventOptions['start_date'], $eventOptions['end_date'],]]></search>
		<add><![CDATA[array(
			$eventOptions['board'], $eventOptions['topic'], $eventOptions['title'], $eventOptions['member'],
			$eventOptions['start_date'], $eventOptions['end_date'], $forumid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[function modifyEvent($event_id, &$eventOptions)
{
	global $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[WHERE id_event = {int:id_event}',
		array(
			'start_date']]></search>
		<add><![CDATA[WHERE id_event = {int:id_event}
			AND forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,
			'start_date']]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[global $smcFunc;

	$smcFunc['db_query']('', '
		DELETE FROM {db_prefix}calendar
		WHERE id_event = {int:id_event}',
		array(]]></search>
		<add><![CDATA[global $smcFunc, $forumid;

	$smcFunc['db_query']('', '
		DELETE FROM {db_prefix}calendar
		WHERE id_event = {int:id_event}
			AND forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[function getEventProperties($event_id)
{
	global $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}topics AS t ON (t.id_topic = c.id_topic)
		WHERE c.id_event = {int:id_event}',
		array(]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}topics AS t ON (t.id_topic = c.id_topic)
		WHERE c.id_event = {int:id_event}
			AND c.forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Categories.php">
	<operation>
		<search position="after"><![CDATA[	// Do the updates (if any).]]></search>
		<add><![CDATA[	// Which forum will this category be displayed on?
	if (isset($catOptions['forumid']))
	{
		$catUpdates[] = 'forumid = {int:forumid}';
		$catParameters['forumid'] = (int)$catOptions['forumid'];
	}

	]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Members.php">
	<operation>
		<search position="replace"><![CDATA['id_post_group' => 4,]]></search>
		<add><![CDATA['id_group' => !empty($modSettings['primary_membergroup']) ? $modSettings['primary_membergroup'] : '0',
		'id_post_group' => 4,]]></add>
	</operation>
</file>	
<file name="$sourcedir/Subs-MessageIndex.php">
	<operation>
		<search position="before"><![CDATA[global $smcFunc, $user_info]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = {int:forumid})]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[	$request = $smcFunc['db_query']('messageindex_fetch_boards', ']]></search>
		<add><![CDATA[	$where[] = 'b.id_cat = c.id_cat';
]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$where_parameters = array();]]></search>
		<add><![CDATA[$where_parameters = array('forumid' => (int) $forumid);]]></add>
	</operation>
</file>
<file name="$sourcedir/Who.php">
	<operation>
		<search position="before"><![CDATA[global $context, $scripturl, $user_info, $txt, $modSettings, $memberContext, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[$conditions = array();]]></search>
		<add><![CDATA[
	if (!empty($modSettings['subforum_settings_show_who_in_subforum']))
		$conditions[] = 'INSTR(lo.url, {string:in_url_string}) > 0';]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[WHERE ' . implode(' AND ', $conditions) : ''),
		array(]]></search>
		<add><![CDATA[
			'in_url_string' => 's:7:"forumid";i:' . ((int) $forumid) . ';',]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[LIMIT {int:offset}, {int:limit}',
		array(]]></search>
		<add><![CDATA[
			'in_url_string' => 's:7:"forumid";i:' . ((int) $forumid) . ';',]]></add>
	</operation>
</file>

<!---------------------------------------------------------------------------->
<!-- Template Edits															-->
<!---------------------------------------------------------------------------->
<file name="$themedir/index.template.php">
	<operation>
		<search position="before"><![CDATA[function template_html_above()
{
	global $context, $settings, $options, $scripturl, $txt, $modSettings]]></search>
		<add><![CDATA[, $favicon]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[
</head>]]></search>
		<add><![CDATA[';
	if (!empty($favicon))
		echo '<link rel="shortcut icon" href="'.$favicon.'" type="image/x-icon" />
<link rel="icon" href="'.$favicon.'" type="image/x-icon" />';
echo '
]]></add>
	</operation>
</file>
<file name="$themedir/ManageBoards.template.php">
	<operation>
		<search position="replace"><![CDATA[global $context, $settings, $options, $scripturl, $txt, $modSettings;

	// Table header.
	echo '
	<div id="manage_boards">
		<div class="title_bar">
			<h3 class="titlebg">', $txt['boardsEdit'], '</h3>
		</div>';

	if (!empty($context['move_board']))
		echo '
		<div class="information">
			<p>', $context['move_title'], ' [<a href="', $scripturl, '?action=admin;area=manageboards">', $txt['mboards_cancel_moving'], '</a>]', '</p>
		</div>';
]]></search>
		<add><![CDATA[global $context, $settings, $options, $scripturl, $txt, $modSettings;
	global $subforum_tree, $cat_tree, $forumid;

	// Table header.
	echo '
	<script type="text/javascript"><!-- // --><![CDATA[<]]><![CDATA[![CDATA[
		function expandTabs(forum)
		{
			';
	foreach ($subforum_tree as $subforum => $info)
		echo 'document.getElementById("subforum' . $subforum . '").style.display = (forum == ' . $subforum . ' ? "" : "none");
			document.getElementById("tab' . $subforum . '").className = (forum == ' . $subforum . ' ? "tabActiveHeader" : "");
			';
	echo '
		}
	// ]]]]><![CDATA[></script>
	<div id="manage_boards">
		<div class="title_bar">
			<h3 class="titlebg">', $txt['boardsEdit'], '</h3>
		</div>';

	if (!empty($context['move_board']))
		echo '
		<div class="information">
			<p>', $context['move_title'], ' [<a href="', $scripturl, '?action=admin;area=manageboards">', $txt['mboards_cancel_moving'], '</a>]', '</p>
		</div>';

	// Display the subforums as a tab at the top of the screen:
	$flagged = array( 0 => false );
	if (count($subforum_tree) > 1)
	{
		echo '
		<div id="tabContainer">
			<div class="tabs">
				<ul>';
		foreach ($subforum_tree as $id => $section)
		{
			echo '
					<li', ($id == $context['req_forumid'] ? ' class="tabActiveHeader"' : ''), ' id="tab' . $id . '"><a href="javascript:void(0);" onclick="expandTabs(' . $id . '); return false;">', (isset($section['boardname']) ? $section['boardname'] : '# '.$section['forumid']), '</a></li>';
			$flagged[$id] = false;
		}
		echo '
				</ul>
			</div>
		</div>';
	}
]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[</div>
	<br class="clear" />';
}

// Template for editing/adding a category on the forum.
function template_modify_category()
{
	global $context, $settings, $options, $scripturl, $txt;

	// Print table header.
	echo '
	<div id="manage_boards">
		<form action="', $scripturl, '?action=admin;area=manageboards;sa=cat2" method="post" accept-charset="', $context['character_set'], '">
			<input type="hidden" name="cat" value="', $context['category']['id'], '" />]]></search>
		<add><![CDATA[</div></div>';
	foreach ($flagged as $id => $flag)
	{
		if (!$flag)
			echo '
	<div id="subforum' . $id . '"' . ($context['req_forumid'] <> $id ? ' style="display: none;"' : '') . '>
		<div class="windowbg">
			<span class="topslice"><span></span></span>
			<div class="content centertext">
				', $txt['mboards_no_cats'], '
			</div>
			<span class="botslice"><span></span></span>
		</div>
	</div>';
	}
	echo '
	<br class="clear" />';
}

// Template for editing/adding a category on the forum.
function template_modify_category()
{
	global $context, $settings, $options, $scripturl, $txt, $subforum_tree, $forumid;

	// Print table header.
	echo '
	<script type="text/javascript"><!-- // --><![CDATA[<]]><![CDATA[![CDATA[
		function SubForumsCategories(forum)
		{
			';
	foreach ($subforum_tree as $subforum => $info)
		echo 'document.getElementById("cat_txt' . $subforum . '").style.display = (forum == ' . $subforum . ' ? "" : "none");
			document.getElementById("cat_ord' . $subforum . '").style.display = (forum == ' . $subforum . ' ? "" : "none");
			';
	echo '
		}
	// ]]]]><![CDATA[></script>
	<div id="manage_boards">
		<form action="', $scripturl, '?action=admin;area=manageboards;sa=cat2' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : '') .'" method="post" accept-charset="', $context['character_set'], '">
			<input type="hidden" name="cat" value="', $context['category']['id'], '" />
			<input type="hidden" name="forumid" value="', $context['category']['forumid'], '" />]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Link to modify the category.
		echo '
			<div class="cat_bar">
				<h3 class="catbg">
					<a href="' . $scripturl . '?action=admin;area=manageboards;sa=cat;cat=' . $category['id'] . '">', $category['name'], '</a> <a href="' . $scripturl . '?action=admin;area=manageboards;sa=cat;cat=' . $category['id'] . '">', $txt['catModify'], '</a>]]></search>
		<add><![CDATA[// Link to modify the category.
		echo '
			<div class="cat_bar">
				<h3 class="catbg">
					<a href="' . $scripturl . '?action=admin;area=manageboards;sa=cat;cat=' . $category['id'] . ($forumid == 0 ? ';sub=' . $category['forumid'] : '') . '">', $category['name'], '</a> <a href="' . $scripturl . '?action=admin;area=manageboards;sa=cat;cat=' . $category['id'] . ';sub=' . $category['forumid'] . '">', $txt['catModify'], '</a>]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[<form action="', $scripturl, '?action=admin;area=manageboards;sa=newboard;cat=', $category['id'], '" method="post" accept-charset="', $context['character_set'], '">]]></search>
		<add><![CDATA[<form action="', $scripturl, '?action=admin;area=manageboards;sa=newboard;cat=', $category['id'], ($forumid == 0 ? ';sub=' . $category['forumid'] : ''), '" method="post" accept-charset="', $context['character_set'], '">]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[function template_confirm_category_delete()
{
	global $context, $settings, $options, $scripturl, $txt;

	// Print table header.
	echo '
	<div id="manage_boards">
		<form action="', $scripturl, '?action=admin;area=manageboards;sa=cat2" method="post" accept-charset="', $context['character_set'], '">]]></search>
		<add><![CDATA[function template_confirm_category_delete()
{
	global $context, $settings, $options, $scripturl, $txt;

	// Print table header.
	echo '
	<div id="manage_boards">
		<form action="', $scripturl, '?action=admin;area=manageboards;sa=cat2' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : '') .'" method="post" accept-charset="', $context['character_set'], '">]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[function template_modify_board()
{
	global $context, $settings, $options, $scripturl, $txt, $modSettings]]></search>
		<add><![CDATA[, $forumid, $subforum_tree]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// The main table header.
	echo '
	<div id="manage_boards">
		<form action="', $scripturl, '?action=admin;area=manageboards;sa=board2" method="post" accept-charset="', $context['character_set'], '">]]></search>
		<add><![CDATA[// The main table header.
	echo '
	<script type="text/javascript"><!-- // --><![CDATA[<]]><![CDATA[![CDATA[
		function hideCategories(forum)
		{';
	foreach ($subforum_tree as $subforum)
		echo '
			document.getElementById("new_cat' . $subforum['forumid'] . '").style.display = (forum == ' . $subforum['forumid'] . ' ? "" : "none");';
	echo '
			hideBoards(document.getElementById("new_cat" + forum).options[document.getElementById("new_cat" + forum).selectedIndex].value);
		}
		function hideBoards(cat)
		{
			cat = (cat == 0 ? ' . $context['board']['id'] . ' : cat);';
	foreach ($context['board_order'] as $cat => $boards2)
		echo '
			document.getElementById("cat_txt', $cat, '").style.display = (cat == ' . $cat . ' ? "" : "none");
			document.getElementById("cat_opt', $cat, '").style.display = (cat == ' . $cat . ' ? "" : "none");';
	echo '
		}
		function expandTabs(forum)
		{
			';
	foreach ($subforum_tree as $subforum => $info)
		echo 'document.getElementById("subforum' . $subforum . '").style.display = (forum == ' . $subforum . ' ? "" : "none");
			document.getElementById("tab' . $subforum . '").className = (forum == ' . $subforum . ' ? "tabActiveHeader" : "");
			';
	echo '
		}
	// ]]]]><![CDATA[></script>
	<div id="manage_boards">
		<form action="', $scripturl, '?action=admin;area=manageboards;sa=board2', (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : ''), '" method="post" accept-charset="', $context['character_set'], '">]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[function template_confirm_board_delete()
{
	global $context, $settings, $options, $scripturl, $txt;

	// Print table header.
	echo '
	<div id="manage_boards">
		<form action="', $scripturl, '?action=admin;area=manageboards;sa=board2" method="post" accept-charset="', $context['character_set'], '">]]></search>
		<add><![CDATA[function template_confirm_board_delete()
{
	global $context, $settings, $options, $scripturl, $txt;

	// Print table header.
	echo '
	<div id="manage_boards">
		<form action="', $scripturl, '?action=admin;area=manageboards;sa=board2' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : '') .'" method="post" accept-charset="', $context['character_set'], '">]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[<li', !empty($modSettings['recycle_board']) && !empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] == $board['id'] ? ' id="recycle_board"' : ' ', ' class="windowbg', $alternate ? '' : '2', '" style="padding-' . ($context['right_to_left'] ? 'right' : 'left') . ': ', 5 + 30 * $board['child_level'], 'px;', $board['move'] ? 'color: red;' : '', '"><span class="floatleft"><a href="', $scripturl, '?board=', $board['id'], '">', $board['name'],]]></search>
		<add><![CDATA[<li', !empty($modSettings['recycle_board']) && !empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] == $board['id'] ? ' id="recycle_board"' : ' ', ' class="windowbg', $alternate ? '' : '2', '" style="padding-' . ($context['right_to_left'] ? 'right' : 'left') . ': ', 5 + 30 * $board['child_level'], 'px;', $board['move'] ? 'color: red;' : '', '"><span class="floatleft"><a href="', $subforum_tree[$category['forumid']]['boardurl'], '/index.php?board=', $board['id'], '">', $board['name'],]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[!empty($modSettings['recycle_board']) && !empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] == $board['id'] ? '<a href="' . $scripturl . '?action=admin;area=manageboards;sa=settings"> <img src="' . $settings['images_url'] . '/post/recycled.gif" alt="' . $txt['recycle_board'] . '" /></a></span>' : '</span>', ']]></search>
		<add><![CDATA[!empty($modSettings['recycle_board']) && !empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] == $board['id'] ? '<a href="' . $subforum_tree[$category['forumid']]['boardurl'] . '?action=admin;area=manageboards;sa=settings"> <img src="' . $settings['images_url'] . '/post/recycled.gif" alt="' . $txt['recycle_board'] . '" /></a></span>' : '</span>', ']]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[<span class="modify_boards"><a href="', $scripturl, '?action=admin;area=manageboards;move=', $board['id'], '">]]></search>
		<add><![CDATA[<span class="modify_boards"><a href="', $scripturl, '?action=admin;area=manageboards;move=', $board['id'], ($forumid == 0 ? ';sub=' . $category['forumid'] : ''), '">]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[<span class="modify_boards"><a href="', $scripturl, '?action=admin;area=manageboards;sa=board;boardid=', $board['id'], '">]]></search>
		<add><![CDATA[<span class="modify_boards"><a href="', $scripturl, '?action=admin;area=manageboards;sa=board;boardid=', $board['id'], ($forumid == 0 ? ';sub=' . $category['forumid'] : ''), '">]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// No categories so show a label.
	if (empty($context['categories']))
		echo '
		<div class="windowbg">
			<span class="topslice"><span></span></span>
			<div class="content centertext">
				', $txt['mboards_no_cats'], '
			</div>
			<span class="botslice"><span></span></span>
		</div>';

	// Loop through every category, listing the boards in each as we go.
	foreach ($context['categories'] as $category)
	{
		]]></search>
		<add><![CDATA[// Loop through every category, listing the boards in each as we go.
	$last_forumid = -1;
	foreach ($context['categories'] as $category)
	{
		// If this is a different subforum, place it in a div:
		if ($last_forumid <> $category['forumid'])
		{
			if ($last_forumid > -1)
				echo '</div>';
			echo '<div id="subforum' . $category['forumid'] . '"' . ($context['req_forumid'] <> (int)$category['forumid'] ? ' style="display: none;"' : '') . '>';
			$last_forumid = $category['forumid'];
			$flagged[$category['forumid']] = true;
		}
	
		]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[// Option for choosing the category the board lives in.]]></search>
		<add><![CDATA[// Option for choosing the subforum the board lives in.
	$_REQUEST['sub'] = (isset($_REQUEST['sub']) ? $_REQUEST['sub'] : 0);
	if (count($subforum_tree) > 1)
	{
		echo '
						<dt>
							<strong>', $txt['forumid_title'], ':</strong>

						</dt>
						<dd>
							<select name="new_forum" onchange="hideCategories(this.options[this.selectedIndex].value);">';
		foreach ($subforum_tree as $subforum)
			echo '
								<option value="', $subforum['forumid'], '" ', $subforum['forumid'] == $_REQUEST['sub'] ? ' selected="selected"' : '', '>', $subforum['boardname'], '</option>';
		echo '
							</select>
						</dd>';
	}
	else
		echo '
						<input type="hidden" name="new_forum" value="', $_REQUEST['sub'], '" />';
	
	]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[<dd>
							<select name="new_cat" onchange="if (this.form.order) {this.form.order.disabled = this.options[this.selectedIndex].value != 0; this.form.board_order.disabled = this.options[this.selectedIndex].value != 0 || this.form.order.options[this.form.order.selectedIndex].value == \'\';}">';
		foreach ($context['categories'] as $category)
			echo '
								<option', $category['selected'] ? ' selected="selected"' : '', ' value="', $category['id'], '">', $category['name'], '</option>';
		echo '
							</select>
						</dd>';

	// If this isn't the only board in this category let the user choose where the board is to live.
	if ((isset($context['board']['is_new']) && count($context['board_order']) > 0) || count($context['board_order']) > 1)
	{
		echo '
						<dt>
							<strong>', $txt['order'], ':</strong>
						</dt>
						<dd>';

	// The first select box gives the user the option to position it before, after or as a child of another board.
	echo '
							<select id="order" name="placement" onchange="this.form.board_order.disabled = this.options[this.selectedIndex].value == \'\';">
								', !isset($context['board']['is_new']) ? '<option value="">(' . $txt['mboards_unchanged'] . ')</option>' : '', '
								<option value="after">' . $txt['mboards_order_after'] . '...</option>
								<option value="child">' . $txt['mboards_order_child_of'] . '...</option>
								<option value="before">' . $txt['mboards_order_before'] . '...</option>
							</select>';

	// The second select box lists all the boards in the category.
	echo '
							<select id="board_order" name="board_order" ', isset($context['board']['is_new']) ? '' : 'disabled="disabled"', '>
								', !isset($context['board']['is_new']) ? '<option value="">(' . $txt['mboards_unchanged'] . ')</option>' : '';
	foreach ($context['board_order'] as $order)
		echo '
								<option', $order['selected'] ? ' selected="selected"' : '', ' value="', $order['id'], '">', $order['name'], '</option>';
	echo '
							</select>
						</dd>';
	}]]></search>
	<add><![CDATA[<dd>';
	foreach ($subforum_tree as $subforum)
	{
		echo '
							<select name="new_cat', $subforum['forumid'], '" id="new_cat', $subforum['forumid'], '" onchange="hideBoards(this.options[this.selectedIndex].value);"', ($subforum['forumid'] <> $_REQUEST['sub'] ? ' style="display: none;"' : ''), ((isset($context['board']['is_new']) && count($context['categories'][$subforum['forumid']]) > 0) || count($context['categories'][$subforum['forumid']]) > 1 ? '' : ' disabled="disabled"'), '>';
		foreach ($context['categories'][$subforum['forumid']] as $category)
			echo '
								<option', $category['selected'] ? ' selected="selected"' : '', ' value="', $category['id'], '">', $category['name'], '</option>';
		echo '
							</select>';
		if (!((isset($context['board']['is_new']) && count($context['categories'][$subforum['forumid']]) > 0) || count($context['categories'][$subforum['forumid']]) > 1))
			echo '
							<input type="hidden" name="new_cat', $subforum['forumid'], '" value="', $context['categories'][$subforum['forumid']][0]['id'], '" />';
	}
	echo '
							<input type="hidden" name="current_cat" value="', $context['board']['category'], '" />
						</dd>';

	// If this isn't the only board in this category let the user choose where the board is to live.
	foreach ($context['board_order'] as $cat => $board_order)
	{
		if ((isset($context['board']['is_new']) && count($board_order) > 0) || count($board_order) > 1)
		{
			echo '
						<dt id="cat_txt', $cat, '"', ($cat != $context['board']['category'] ? ' style="display: none;"' : '') . '>
							<strong>', $txt['order'], ':</strong>
						</dt>
						<dd id="cat_opt', $cat, '"', ($cat != $context['board']['category'] ? ' style="display: none;"' : '') . '>';

			// The first select box gives the user the option to position it before, after or as a child of another board.
			echo '
							<select id="order', $cat, '" name="placement', $cat, '" onchange="this.form.board_order', $cat, '.disabled = this.options[this.selectedIndex].value == \'\';">
								', !isset($context['board']['is_new']) ? '<option value="">(' . $txt['mboards_unchanged'] . ')</option>' : '', '
								<option value="after">' . $txt['mboards_order_after'] . '...</option>
								<option value="child">' . $txt['mboards_order_child_of'] . '...</option>
								<option value="before">' . $txt['mboards_order_before'] . '...</option>
							</select>';

			// The second select box lists all the boards in the category.
			echo '
							<select id="board_order', $cat, '" name="board_order', $cat, '" ', isset($context['board']['is_new']) ? '' : 'disabled="disabled"', '>
								', !isset($context['board']['is_new']) ? '<option value="">(' . $txt['mboards_unchanged'] . ')</option>' : '';
			foreach ($board_order as $order)
				echo '
								<option', $order['selected'] ? ' selected="selected"' : '', ' value="', $order['id'], '">', $order['name'], '</option>';
			echo '
							</select>
						</dd>';
		}
	}]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[foreach ($context['category_order'] as $cat)]]></search>
		<add><![CDATA[foreach ($context['category_order'][$_POST['forumid']] as $cat)]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[<label for="delete_action1"><input type="radio" id="delete_action1" name="delete_action" value="1" class="input_radio"', count($context['category_order']) == 1 ? ' disabled="disabled"' : '', ' />', $txt['mboards_delete_option2'], '</label>:]]></search>
		<add><![CDATA[<label for="delete_action1"><input type="radio" id="delete_action1" name="delete_action" value="1" class="input_radio"', count($context['category_order'][$_POST['forumid']]) == 1 ? ' disabled="disabled"' : '', ' />', $txt['mboards_delete_option2'], '</label>:]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// If this isn't the only category, let the user choose where this category should be positioned down the board index.
	if (count($context['category_order']) > 1)
	{
		echo '
						<dt><strong>', $txt['order'], ':</strong></dt>
						<dd>
							<select name="cat_order">';
		// Print every existing category into a select box.
		foreach ($context['category_order'] as $order)
			echo '
								<option', $order['selected'] ? ' selected="selected"' : '', ' value="', $order['id'], '">', $order['name'], '</option>';
		echo '
							</select>
						</dd>';
	}]]></search>
		<add><![CDATA[// If this isn't the only subforum, let the user choose which subforum it should be placed in:
	if (count($subforum_tree) > 1)
	{
		echo '
						<dt>
							<strong>' . $txt['forumid_title']. '</strong><br />
							<span class="smalltext">' . $txt['forumid_desc'] . '</span>
						</dt>
						<dd>
							<select name="forum_id" onchange="SubForumsCategories(this.options[this.selectedIndex].value); return false;">';
		// Print every existing category into a select box.
		foreach ($subforum_tree as $row)
			echo '
								<option', $context['category']['forumid'] == $row['forumid'] ? ' selected="selected"' : '', ' value="', $row['forumid'], '">', $row['boardname'], '</option>';
		echo '
							</select>
						</dd>';
	} else {
		echo '
						<input type="hidden" name="forum_id" value="', $forumid, '" size="4" tabindex="', $context['tabindex']++, '" />';
	}

	// If this isn't the only category, let the user choose where this category should be positioned down the board index.
	foreach ($subforum_tree as $id => $subforum)
	{
		echo '
						<dt id="cat_txt' . $id . '"' . ($id <> $_REQUEST['sub'] ? ' style="display: none;"' : '') . '>
							<strong>', $txt['order'], ':</strong>
						</dt>
						<dd id="cat_ord' . $id . '"' . ($id <> $_REQUEST['sub'] ? ' style="display: none;"' : '') . '>
							<select name="cat_order' . $id . '"">';

		// Print every existing category into a select box.
		foreach ($context['category_order'][$id] as $order)
			echo '
									<option', $order['selected'] ? ' selected="selected"' : '', ' value="', $order['id'], '">', $order['name'], '</option>';
		echo '
							</select>
						</dd>';
	}]]></add>
	</operation>

	<operation error="ignore">
		<search position="replace"><![CDATA[<div id="alias_board"', ($context['board']['alias_board'] == 0 ? ' style="display: none;"' : ''), '>
					<fieldset>
						<legend>', $txt['mboards_alias_legend'], '</legend>]]></search>
		<add><![CDATA[<div id="alias_board"', ($context['board']['alias_board'] == 0 ? ' style="display: none;"' : ''), '>';

	// Display the subforums as a tab at the top of the screen:
	$flagged = array( 0 => false );
	if (count($subforum_tree) > 1)
	{
		echo '
					<div id="tabContainer">
						<div class="tabs">
							<ul>';
		foreach ($subforum_tree as $id => $section)
		{
			echo '
								<li', ($id == $context['req_forumid'] ? ' class="tabActiveHeader"' : ''), ' id="tab' . $id . '"><a href="javascript:void(0);" onclick="expandTabs(' . $id . '); return false;">', (isset($section['boardname']) ? $section['boardname'] : '# '.$section['forumid']), '</a></li>';
			$flagged[$id] = false;
		}
		echo '
							</ul>
						</div>
					</div>';
	}

	echo '
					<fieldset>', (count($subforum_tree) == 1 ? '
						<legend>' . $txt['mboards_alias_legend'] . '</legend>' : ''), ']]></add>
	</operation>
	<operation error="ignore">
		<search position="replace"><![CDATA[$last_cat = 0;
	foreach ($boards as $id => $board)
	{
		]]></search>
		<add><![CDATA[$last_cat = 0;
	$last_forumid = -1;
	foreach ($boards as $board)
	{
		if (isset($board['forumid']) && $last_forumid <> $board['forumid'])
		{
			if ($last_forumid > -1)
				echo '</div>';
			echo '<div id="subforum' . $board['forumid'] . '"' . ($context['req_forumid'] <> (int)$board['forumid'] ? ' style="display: none;"' : '') . '>';
			$last_forumid = $board['forumid'];
			$flagged[$board['forumid']] = true;
			$last_cat = 0;
		}
		]]></add>
	</operation>
	<operation error="ignore">
		<search position="replace"><![CDATA[<input type="radio" name="alias_board" value="', $board['id'], '"', ($context['board']['alias_board'] == $board['id'] ? ' checked="checked"' : ''), '>', $board['name'], '<br />';
	}
	echo '
							</dd>]]></search>
		<add><![CDATA[<input type="radio" name="alias_board" value="', $board['id'], '"', ($context['board']['alias_board'] == $board['id'] ? ' checked="checked"' : ''), '>', $board['name'], '<br />';
	}
	echo '
							</div></dd>]]></add>
	</operation>
</file>
<file name="$themedir/ManageMembergroups.template.php">
	<!-- template_add_group -->
	<operation>
		<search position="before"><![CDATA[function template_new_group()
{
	global $context, $settings, $options, $scripturl, $txt, $modSettings]]></search>
		<add><![CDATA[, $subforum_tree]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[echo '
						<dt>
							<strong>', $txt['membergroups_new_board'], ':</strong>', $context['post_group'] ? '<br />
							<span class="smalltext" style="font-weight: normal">' . $txt['membergroups_new_board_post_groups'] . '</span>' : '', '
						</dt>
						<dd>
							<fieldset id="visible_boards">
								<legend>', $txt['membergroups_new_board_desc'], '</legend>';
	foreach ($context['boards'] as $board)
		echo '
								<div style="margin-left: ', $board['child_level'], 'em;"><input type="checkbox" name="boardaccess[]" id="boardaccess_', $board['id'], '" value="', $board['id'], '" ', $board['selected'] ? ' checked="checked" disabled="disabled"' : '', ' class="input_check" /> <label for="boardaccess_', $board['id'], '">', $board['name'], '</label></div>';

	echo '
								<br />
								<input type="checkbox" id="checkall_check" class="input_check" onclick="invertAll(this, this.form, \'boardaccess\');" /> <label for="checkall_check"><em>', $txt['check_all'], '</em></label>
							</fieldset>
						</dd>
					</dl>]]></search>
		<add><![CDATA[// Display the subforums as a tab at the top of the screen:
	if (!empty($context['boards']))
	{
		if (count($subforum_tree) > 1)
		{
			echo '
						<script type="text/javascript"><!-- // -->
							function modSubforum(forum, state)
							{
								var elem = document.getElementsByClassName("subforum_" + forum);
								for (i = 0; i < elem.length; i++)
									elem[i].style.display = (state ? "" : "none");
							}
							function expandTabs(forum)
							{
								';
			foreach ($subforum_tree as $subforum => $info)
				echo 'modSubforum(', $subforum, ', forum == ', $subforum, ');
								document.getElementById("tab' . $subforum . '").className = (forum == ' . $subforum . ' ? "tabActiveHeader" : "");
								';
			echo '
							}
						</script>
					</dl>
					<div id="tabContainer">
						<div class="tabs">
							<ul>';
			foreach ($subforum_tree as $id => $section)
			{
				echo '
								<li', ($id == $context['req_forumid'] ? ' class="tabActiveHeader"' : ''), ' id="tab' . $id . '"><a href="javascript:void(0);" onclick="expandTabs(' . $id . '); return false;">', (isset($section['boardname']) ? $section['boardname'] : '# '.$section['forumid']), '</a></li>';
				$flagged[$id] = false;
			}
			echo '
							</ul>
						</div>
					</div>
					<hr class="hrcolor" />
					<dl class="settings">';
		}
		echo '
						<dt>
							<strong>', $txt['membergroups_new_board'], ':</strong>', $context['post_group'] ? '<br />
							<span class="smalltext">' . $txt['membergroups_new_board_post_groups'] . '</span>' : '', '
						</dt>
						<dd>
							<fieldset id="visible_boards" style="width: 95%;">
								<legend>', $txt['membergroups_new_board_desc'], '</legend>';
		foreach ($context['boards'] as $board)
			if (isset($subforum_tree[$board['forumid']]))
				echo '
								<div style="margin-left: ', $board['child_level'], 'em;" class="subforum_' . $board['forumid'] . '"><input type="checkbox" name="boardaccess[]" id="boardaccess_', $board['id'], '" value="', $board['id'], '" ', $board['selected'] ? ' checked="checked"' : '', ' class="input_check" /> <label for="boardaccess_', $board['id'], '">', $board['name'], '</label></div>';
			elseif ($board['selected'])
				echo '
								<input type="hidden" name="boardaccess[]" value="' . $board['id'] . '" />';

		echo '
							<br />
							<input type="checkbox" id="checkall_check" class="input_check" onclick="invertAll(this, this.form, \'boardaccess\');" /> <label for="checkall_check"><em>', $txt['check_all'], '</em></label>
							</fieldset>
						</dd>
					</dl>';
	}
	echo ']]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[</div>';
	if ($context['undefined_group'])]]></search>
		<add><![CDATA[</div>';
	if (count($subforum_tree) > 1)
	{
		$keys = array_keys($subforum_tree);
		echo '
			<script type="text/javascript">
				expandTabs(', $keys[0], ');
			</script>';
	}
	if ($context['undefined_group'])]]></add>
	</operation>
	
	<!-- template_edit_group -->
	<operation>
		<search position="before"><![CDATA[function template_edit_group()
{
	global $context, $settings, $options, $scripturl, $txt]]></search>
		<add><![CDATA[, $subforum_tree]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[if (!empty($context['boards']))
	{
		echo '
						<dt>
							<strong>', $txt['membergroups_new_board'], ':</strong>', $context['group']['is_post_group'] ? '<br />
							<span class="smalltext">' . $txt['membergroups_new_board_post_groups'] . '</span>' : '', '
						</dt>
						<dd>
							<fieldset id="visible_boards" style="width: 95%;">
								<legend><a href="javascript:void(0);" onclick="document.getElementById(\'visible_boards\').style.display = \'none\';document.getElementById(\'visible_boards_link\').style.display = \'block\'; return false;">', $txt['membergroups_new_board_desc'], '</a></legend>';
		foreach ($context['boards'] as $board)
			echo '
								<div style="margin-left: ', $board['child_level'], 'em;"><input type="checkbox" name="boardaccess[]" id="boardaccess_', $board['id'], '" value="', $board['id'], '" ', $board['selected'] ? ' checked="checked"' : '', ' class="input_check" /> <label for="boardaccess_', $board['id'], '">', $board['name'], '</label></div>';

		echo '
								<br />
								<input type="checkbox" id="checkall_check" class="input_check" onclick="invertAll(this, this.form, \'boardaccess\');" /> <label for="checkall_check"><em>', $txt['check_all'], '</em></label>
							</fieldset>
							<a href="javascript:void(0);" onclick="document.getElementById(\'visible_boards\').style.display = \'block\'; document.getElementById(\'visible_boards_link\').style.display = \'none\'; return false;" id="visible_boards_link" style="display: none;">[ ', $txt['membergroups_select_visible_boards'], ' ]</a>
							<script type="text/javascript"><!-- // --><![CDATA[<]]><![CDATA[![CDATA[
								document.getElementById("visible_boards_link").style.display = "";
								document.getElementById("visible_boards").style.display = "none";]]></search>
		<add><![CDATA[if (!empty($context['boards']))
	{
		if (count($subforum_tree) > 1)
		{
			echo '
					</dl>
					<script type="text/javascript"><!-- // -->
						function modSubforum(forum, state)
						{
							var elem = document.getElementsByClassName("subforum_" + forum);
							for (i = 0; i < elem.length; i++)
								elem[i].style.display = (state ? "" : "none");
						}
						function expandTabs(forum)
						{
							';
			foreach ($subforum_tree as $subforum => $info)
				echo 'modSubforum(', $subforum, ', forum == ', $subforum, ');
							document.getElementById("tab' . $subforum . '").className = (forum == ' . $subforum . ' ? "tabActiveHeader" : "");
							';
			echo '
						}
					</script>
					<div id="tabContainer">
						<div class="tabs">
							<ul>';
			foreach ($subforum_tree as $id => $section)
			{
				echo '
								<li', ($id == $context['req_forumid'] ? ' class="tabActiveHeader"' : ''), ' id="tab' . $id . '"><a href="javascript:void(0);" onclick="expandTabs(' . $id . '); return false;">', (isset($section['boardname']) ? $section['boardname'] : '# '.$section['forumid']), '</a></li>';
				$flagged[$id] = false;
			}
			echo '
							</ul>
						</div>
						<hr class="hrcolor" />
					</div>
					<dl class="settings">';
		}

		echo '
						<dt>
							<strong>', $txt['membergroups_new_board'], ':</strong>', $context['group']['is_post_group'] ? '<br />
							<span class="smalltext">' . $txt['membergroups_new_board_post_groups'] . '</span>' : '', '
						</dt>
						<dd>
							<fieldset id="visible_boards" style="width: 95%;">
								<legend><a href="javascript:void(0);" onclick="document.getElementById(\'visible_boards\').style.display = \'none\';document.getElementById(\'visible_boards_link\').style.display = \'block\';' . (count($subforum_tree) > 1 ? ' document.getElementById(\'tabContainer\').style.display = \'none\';' : '') . ' return false;">', $txt['membergroups_new_board_desc'], '</a></legend>';
		foreach ($context['boards'] as $board)
			if (isset($subforum_tree[$board['forumid']]))
				echo '
								<div style="margin-left: ', $board['child_level'], 'em;" class="subforum_' . $board['forumid'] . '"><input type="checkbox" name="boardaccess[]" id="boardaccess_', $board['id'], '" value="', $board['id'], '" ', $board['selected'] ? ' checked="checked"' : '', ' class="input_check" /> <label for="boardaccess_', $board['id'], '">', $board['name'], '</label></div>';
			elseif ($board['selected'])
				echo '
								<input type="hidden" name="boardaccess[]" value="' . $board['id'] . '" />';

		echo '
								<br />
								<input type="checkbox" id="checkall_check" class="input_check" onclick="invertAll(this, this.form, \'boardaccess\');" /> <label for="checkall_check"><em>', $txt['check_all'], '</em></label>
							</fieldset>
							<a href="javascript:void(0);" onclick="document.getElementById(\'visible_boards\').style.display = \'block\'; document.getElementById(\'visible_boards_link\').style.display = \'none\'; ' . (count($subforum_tree) > 1 ? ' document.getElementById(\'tabContainer\').style.display = \'block\';' : '') . ' return false;" id="visible_boards_link" style="display: none;">[ ', $txt['membergroups_select_visible_boards'], ' ]</a>
							<script type="text/javascript"><!-- // -->
								document.getElementById("visible_boards_link").style.display = "";
								document.getElementById("visible_boards").style.display = "none";';
		if (count($subforum_tree) > 1)
		{
			$keys = array_keys($subforum_tree);
			echo '
								document.getElementById("tabContainer").style.display = "none";
								expandTabs(' . $keys[0] . ');';
		}
		echo ']]></add>
	</operation>
</file>
<file name="$themedir/ManagePermissions.template.php">
	<operation>
		<search position="before"><![CDATA[function template_by_board()
{
	global $context, $settings, $options, $scripturl, $txt, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[foreach ($context['categories'] as $category)
	{
		echo '
		<div class="cat_bar">
			<h3 class="catbg"><strong>', $category['name'], '</strong></h3>
		</div>';

		if (!empty($category['boards']))
			echo '
		<div class="windowbg">
			<span class="topslice"><span></span></span>
			<div class="content">
				<ul class="perm_boards flow_hidden">';

		$alternate = false;

		foreach ($category['boards'] as $board)
		{
			$alternate = !$alternate;

			echo '

					<li class="flow_hidden' ,' windowbg', $alternate ? '' : '2','">
						<span class="perm_board floatleft">
							<a href="', $scripturl, '?action=admin;area=manageboards;sa=board;boardid=', $board['id'], ';rid=permissions;', $context['session_var'], '=', $context['session_id'], '">', str_repeat('-', $board['child_level']), ' ', $board['name'], '</a>
						</span>
						<span class="perm_boardprofile floatleft">';
			if ($context['edit_all'])
			{
				echo '
							<select name="boardprofile[', $board['id'], ']">';

				foreach ($context['profiles'] as $id => $profile)
					echo '
								<option value="', $id, '" ', $id == $board['profile'] ? 'selected="selected"' : '', '>', $profile['name'], '</option>';

				echo '
							</select>';
			}
			else
				echo '
							<a href="', $scripturl, '?action=admin;area=permissions;sa=index;pid=', $board['profile'], ';', $context['session_var'], '=', $context['session_id'], '"> [', $board['profile_name'], ']</a>';

			echo '
						</span>
					</li>';
		}

		if (!empty($category['boards']))
			echo '
				</ul>
			</div>
			<span class="botslice"><span></span></span>
		</div>';
	}]]></search>
	<add><![CDATA[// Display the subforums as a tab at the top of the screen:
	$flagged = array( 0 => false );
	if (count($subforum_tree) > 1)
	{
		echo '
		<script type="text/javascript"><!-- // --><![CDATA[<]]><![CDATA[![CDATA[
			function expandTabs(forum)
			{
			';
	foreach ($subforum_tree as $subforum => $info)
		echo 'document.getElementById("subforum' . $subforum . '").style.display = (forum == ' . $subforum . ' ? "" : "none");
				document.getElementById("tab' . $subforum . '").className = (forum == ' . $subforum . ' ? "tabActiveHeader" : "");
				';
	echo '
			}
		// ]]]]><![CDATA[></script>
		<div id="tabContainer">
			<div class="tabs">
				<ul>';
		foreach ($subforum_tree as $id => $section)
		{
			echo '
					<li', ($id == $context['req_forumid'] ? ' class="tabActiveHeader"' : ''), ' id="tab' . $id . '"><a href="javascript:void(0);" onclick="expandTabs(' . $id . '); return false;">', (isset($section['boardname']) ? $section['boardname'] : '# '.$section['forumid']), '</a></li>';
			$flagged[$id] = false;
		}
		echo '
				</ul>
			</div>
		</div>
		<hr class="clear" />';
	}
	foreach ($context['categories'] as $id => $subforum)
	{
		echo '
		<div id="subforum' . $id . '"' . (!empty($id) ? ' style="display: none;"' : '') . '>';
	
		foreach ($subforum as $category)
		{
			echo '
			<div class="cat_bar">
				<h3 class="catbg"><strong>', $category['name'], '</strong></h3>
			</div>';

			if (!empty($category['boards']))
				echo '
			<div class="windowbg">
				<span class="topslice"><span></span></span>
				<div class="content">
					<ul class="perm_boards flow_hidden">';

			$alternate = false;

			foreach ($category['boards'] as $board)
			{
				$alternate = !$alternate;

				echo '

						<li class="flow_hidden' ,' windowbg', $alternate ? '' : '2','">
							<span class="perm_board floatleft">
								<a href="', $scripturl, '?action=admin;area=manageboards;sa=board;boardid=', $board['id'], ';rid=permissions;', $context['session_var'], '=', $context['session_id'], '">', str_repeat('-', $board['child_level']), ' ', $board['name'], '</a>
							</span>
							<span class="perm_boardprofile floatleft">';
				if ($context['edit_all'])
				{
					echo '
								<select name="boardprofile[', $board['id'], ']">';

					foreach ($context['profiles'] as $id => $profile)
						echo '
									<option value="', $id, '" ', $id == $board['profile'] ? 'selected="selected"' : '', '>', $profile['name'], '</option>';

					echo '
								</select>';
				}
				else
					echo '
								<a href="', $scripturl, '?action=admin;area=permissions;sa=index;pid=', $board['profile'], ';', $context['session_var'], '=', $context['session_id'], '"> [', $board['profile_name'], ']</a>';

				echo '
							</span>
						</li>';
			}

			if (!empty($category['boards']))
				echo '
					</ul>
				</div>
				<span class="botslice"><span></span></span>
			</div>';
		}
		$flagged[$id] = true;
		echo '
		</div>';
	}
	foreach ($flagged as $id => $flag)
	{
		if (!$flag)
			echo '
	<div id="subforum' . $id . '"' . ($context['req_forumid'] <> $id ? ' style="display: none;"' : '') . '>
	</div>';
	}]]></add>
	</operation>
</file>
</modification>